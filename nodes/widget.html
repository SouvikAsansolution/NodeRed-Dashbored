<!-- NodeRed Documentation https://nodered.org/docs/creating-nodes/edit-dialog -->

<script type="text/x-red" data-template-name="dashbored-widget">
    <div class="form-row">
        <label for="node-config-input-name">Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-server">Server</label>
        <input type="text" id="node-config-input-server">
    </div>
    <div class="form-row">
        <label for="node-config-input-widgetType">Type</label>
        <input type="text" id="node-config-input-widgetType">
    </div>
    <p id="widget-id" style="color: gray"><p>
    <hr>
    <div class="form-row" id="widget-type-populate-area">
        <p style="color: red">Please deploy to create the widget and populate the settings here</p>
    </div>
    <button id="reset">Reset Configuration</button>
</script>

<script type="text/javascript">
    RED.nodes.registerType("dashbored-widget", {
        category: "config",
        defaults: {
            name: {
                value: "Widget",
                required: true
            },
            server: {
                value: "",
                required: true,
                type: "dashbored-server"
            },
            widgetType: {
                value: "",
                required: true
            }
        },
        label: function () {
            return (this.name || "Toggle Button");
        },
        oneditprepare: async function () {
            var self = this;
            $("#widget-id").html("ID: " + this.id);

            //Grab the widget
            try {
                var widget = await $.ajax({
                    type: "GET",
                    url: "./dashboredAPI",
                    data: "widgets=" + this.id
                });
            } catch (e) { }

            //Grab the types
            try {
                var widgetTypes = await $.ajax({
                    type: "GET",
                    url: "./dashboredAPI",
                    data: "widgetTypes"
                });
            }
            catch (e) { console.error("Failed to get the widget types!!"); return; }

            //Set the widget type selector
            var types = [];
            for (var i in widgetTypes) {
                types.push({
                    label: widgetTypes[i].name,
                    value: i
                });
            }
            $("#node-config-input-widgetType").typedInput({
                types: [{
                    value: "widgetType",
                    options: types
                }]
            });

            if (!widget) { return; }

            var currentWidgetType;
            var setupWidgetType = function (element) {
                //Populate the default config to start
                for (var i in currentWidgetType.defaultConfig) {
                    if (element[i] === undefined) {
                        //Default
                        element[i] = currentWidgetType.defaultConfig[i];
                    }
                }

                //Now populate the config values (if set)
                for (var i in currentWidgetType.config) {
                    if (element[i] === undefined) {
                        //Default
                        element[i] = currentWidgetType.config[i];
                    }
                }

                //Populate the widget type config options
                var div = $("#widget-type-populate-area");
                div.html("");
                div.append(currentWidgetType.configHTML);

                //Run any oneditprepare scripts
                if (currentWidgetType.configScript.oneditprepare) { eval(currentWidgetType.configScript.oneditprepare); }
            }

            $("#reset").on("click", function () {
                console.log(currentWidgetType);
                console.log("fr");
                var element = self;
                var defaultConfig = currentWidgetType.defaultConfig;
                if (currentWidgetType.configScript.reset) { eval(currentWidgetType.configScript.reset); }
            });

            //https://nodered.org/docs/api/ui/typedInput/#methods
            $("#node-config-input-widgetType").typedInput("value", this.widgetType);
            currentWidgetType = widgetTypes[this.widgetType];

            this.currentWidgetType = currentWidgetType;
            setupWidgetType(self);

            //When the user changes the type rerender
            $("#node-config-input-widgetType").on("change", function (event, type) {
                currentWidgetType = widgetTypes[event.target.value];
                self.currentWidgetType = currentWidgetType;
                setupWidgetType(self);
            });
        },
        oneditsave: function () {
            var element = this;
            if (this.currentWidgetType.configScript.oneditsave) { eval(this.currentWidgetType.configScript.oneditsave); }
            this.widgetType = $("#node-config-input-widgetType").val();
        },
        oneditcancel: function () {
            var element = this;
            if (this.currentWidgetType.configScript.oneditcancel) { eval(this.currentWidgetType.configScript.oneditcancel); }
        },
    });
</script>