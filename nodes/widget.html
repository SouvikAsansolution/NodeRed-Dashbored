<!-- NodeRed Documentation https://nodered.org/docs/creating-nodes/edit-dialog -->

<script type="text/x-red" data-template-name="dashbored-widget">
    <p id="widget-id"><p>
    <div class="form-row">
        <label for="node-config-input-name">Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-server">Server</label>
        <input type="text" id="node-config-input-server">
    </div>
    <div class="form-row">
        <label for="node-config-input-widgetType">Type</label>
        <input type="text" id="node-config-input-widgetType">
    </div>
    <hr>
    <div class="form-row" id="widget-type-populate-area">
        <p style="color: red">Please deploy to create the widget and populate the settings here</p>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("dashbored-widget", {
        category: "config",
        defaults: {
            name: {
                value: "Toggle Button",
                required: true
            },
            server: {
                value: "",
                required: true,
                type: "dashbored-server"
            },
            widgetType: {
                value: "",
                required: true
            }
        },
        label: function () {
            return (this.name || "Toggle Button");
        },
        oneditprepare: async function () {
            $("#widget-id").html("Widget ID = " + this.id);

            //Grab the widget
            try {
                var widget = await $.ajax({
                    type: "GET",
                    url: "./dashboredAPI",
                    data: "widgets=" + this.id
                });
            } catch (e) { }

            //Grab the types
            try {
                var widgetTypes = await $.ajax({
                    type: "GET",
                    url: "./dashboredAPI",
                    data: "widgetTypes"
                });
            }
            catch (e) { console.error("Failed to get the widget types!!"); return; }

            widgetType = widgetTypes[widget.widgetType];

            //Populate the values to start
            for (var i in widgetType.config) {
                if(this[i] === undefined) {
                    //Default
                    this[i] = widgetType.config[i];
                }
            }

            //Populate the widget type config options
            var div = $("#widget-type-populate-area");
            div.html("");
            div.append(widgetType.configHTML);

            //Run any oneditprepare scripts
            if(widgetType.configScript.oneditprepare){eval(widgetType.configScript.oneditprepare);}
            this.widgetType = widgetType;

            //Set the widget type selector
            var types = [];
            for (var i in widgetTypes) {
                types.push({
                    label: widgetTypes[i].name,
                    value: i
                });
            }
            $("#node-config-input-widgetType").typedInput({
                types: [{
                    value: "widgetType",
                    options: types
                }]
            });
            $("#node-config-input-widgetType").attr(widget.widgetType, true);
        },
        oneditsave: function () {
            if (this.widgetType.configScript.oneditprepare) { eval(widgetType.configScript.oneditsave); }
        },
        oneditcancel: function () {
            if (this.widgetType.configScript.oneditcancel) { eval(widgetType.configScript.oneditcancel); }
        },
    });
</script>