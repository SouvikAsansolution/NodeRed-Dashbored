<script type="text/x-red" data-template-name="dashbored-dashbored">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-config-input-server"><i class="icon-bookmark"></i> Server</label>
        <input type="text" id="node-config-input-server">
    </div>

    <!-- Page Adder -->
    <h1>Add Page</h1>
    <div class="form-row">
        <label for="node-input-pageName">Name</label>
        <input type="text" id="node-input-pageName">
        <label for="node-input-pageIcon">Icon</label>
        <input type="text" id="node-input-pageIcon">
        <button type="button" class="red-ui-button" id="node-input-page-add">Add</button>
    </div>

    <!-- Widget Adder -->
    <div class="form-row">
        <label for="node-input-widget">Add Widget</label>
        <input type="text" id="node-input-widgets">
        <button type="button" class="red-ui-button" id="node-input-widgets-add">Add</button>
    </div>

    <!-- HTML Editor -->
    <div class="form-row">
        <label for="node-input-html-editor">HTML</label>
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-html-editor"></div>
    </div>
    <!-- CSS Editor -->
    <div class="form-row">
        <label for="node-input-css-editor">CSS</label>
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-css-editor"></div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("dashbored-dashbored", {
        category: "config",
        defaults: {
            name: { value: "Dashbored" },
            server: { value: "", required: true, type: "dashbored-server" },

            //The default HTML for the dashbored
            HTML: {
                value: `
                <page name="Example Page">
                    <h1>This is an example page!</h1>
                    <p>Type any HTML here to have it display on the page</p>
                    <hr>
                    <p>You can add widgets with the following</p>
                    <code><widget id="4c385a0.f7d2ba8"></widget></code>
                    <p>See an example by putting your cursor here and adding a widget in the dashbored editor!</p>
                </page>
                <page name="Example Page 2">
                    <h1>This is another example page!</h1>
                </page>
                `.replace(/^\s+|\s+$/gm, ''), required: true
            },

            //The default CSS for the dashbored
            CSS: {
                value: `
                /* You can add any CSS here to have it effect the entire dashbored! */
                html {
                    text-align: center;
                }
                `.replace(/^\s+|\s+$/gm, ''), required: true
            }
        },
        label: function () {
            return (this.name || "Dashbored");
        },
        oneditprepare: async function () {
            //Do a call to the server and request the widgets in memory
            var widgetIds = await $.ajax({
                type: "GET",
                url: "./dashboredgetallnodeids"
            });
            for (var i = 0; i < widgetIds.length; i++) {
                widgetIds[i] = JSON.parse(widgetIds[i]);
            }

            $("#node-input-widgets").typedInput({
                types: [
                    {
                        value: "widIds",
                        multiple: "true",
                        options: widgetIds
                    }
                ]
            });

            //Add the page to the HTML
            $("#node-input-page-add").click(() => {
                var name = $("#node-input-pageName").val();
                var icon = $("#node-input-pageIcon").val();
                this.htmlEditor.insert(`<!-- ${name} -->\n<page name="${name}" icon="${icon}">\n</page>`)
            });

            //Add the selected widgets to the HTML
            $("#node-input-widgets-add").click(() => {
                var widgets = $("#node-input-widgets").val().split(",");
                for (var i = 0; i < widgets.length; i++) {
                    for (var j = 0; j < widgetIds.length; j++) {
                        if (widgetIds[j].value == widgets[i]) {
                            this.htmlEditor.insert(`<!-- ${widgetIds[j].label} -->\n<widget name="${widgetIds[j].label}" id="${widgetIds[j].value}"></widget>\n`)
                            break;
                        }
                    }
                }
            });

            //Setup the editors
            this.htmlEditor = RED.editor.createEditor({
                id: "node-input-html-editor",
                mode: "ace/mode/html",
                value: this.HTML
            });
            this.cssEditor = RED.editor.createEditor({
                id: "node-input-css-editor",
                mode: "ace/mode/css",
                value: this.CSS
            });
        },
        oneditsave: function () {
            this.HTML = this.htmlEditor.getValue();
            this.htmlEditor.destroy();
            delete this.htmlEditor;
            this.CSS = this.cssEditor.getValue();
            this.cssEditor.destroy();
            delete this.cssEditor;
        },
        oneditcancel: function () {
            this.htmlEditor.destroy();
            delete this.htmlEditor;
            this.cssEditor.destroy();
            delete this.cssEditor;
        },
    });
</script>